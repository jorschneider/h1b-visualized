<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IFP H-1B Policy Lab</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light;
        --bg-surface: #f7f8fc;
        --bg-panel: #ffffff;
        --bg-emphasis: #ede9fe;
        --bg-chip: rgba(99, 102, 241, 0.08);
        --ink-strong: #181236;
        --ink-soft: rgba(24, 18, 54, 0.78);
        --ink-subtle: rgba(24, 18, 54, 0.55);
        --brand: #5b21b6;
        --brand-strong: #4c1d95;
        --brand-soft: #7c3aed;
        --border-soft: rgba(79, 70, 229, 0.15);
        --shadow-soft: 0 20px 45px rgba(76, 29, 149, 0.08);
        --radius-lg: 26px;
        --radius-md: 18px;
        --radius-sm: 12px;
        --chart-baseline: #4338ca;
        --chart-highlight: #f59e0b;
        --chart-accent: #5b21b6;
        --chart-muted: rgba(79, 70, 229, 0.28);
        --chart-grid: rgba(79, 70, 229, 0.18);
        --chart-axis: rgba(30, 41, 59, 0.72);
        background-color: var(--bg-surface);
      }

      body {
        margin: 0;
        font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif;
        background: var(--bg-surface);
        color: var(--ink-strong);
        min-height: 100vh;
      }

      body.theme-sepia {
        --bg-surface: #f7f1e4;
        --bg-panel: #fff9ef;
        --bg-emphasis: #f2e2c8;
        --bg-chip: rgba(190, 144, 63, 0.1);
        --ink-strong: #432f16;
        --ink-soft: rgba(67, 47, 22, 0.8);
        --ink-subtle: rgba(67, 47, 22, 0.62);
        --brand: #8b5d26;
        --brand-strong: #6c4314;
        --brand-soft: #b7791f;
        --border-soft: rgba(139, 93, 38, 0.26);
        --shadow-soft: 0 20px 45px rgba(108, 67, 20, 0.18);
        --chart-baseline: #8c6239;
        --chart-highlight: #d97706;
        --chart-accent: #6c2a1c;
        --chart-muted: rgba(140, 98, 57, 0.38);
        --chart-grid: rgba(140, 98, 57, 0.22);
        --chart-axis: rgba(72, 54, 32, 0.78);
      }

      .page {
        max-width: 1180px;
        margin: 0 auto;
        padding: 48px 32px 64px;
        display: flex;
        flex-direction: column;
        gap: 48px;
      }

      header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 32px;
      }

      .brand {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .brand img {
        width: 140px;
        height: auto;
      }

      .brand h1 {
        margin: 0;
        font-family: 'Poppins', 'Inter', sans-serif;
        font-size: clamp(2rem, 3vw + 1rem, 3rem);
        letter-spacing: -0.02em;
      }

      .brand p {
        margin: 6px 0 0;
        color: var(--ink-subtle);
        max-width: 520px;
        line-height: 1.5;
      }

      .theme-toggle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        border: none;
        border-radius: 999px;
        padding: 0.85rem 1.2rem;
        background: var(--bg-chip);
        color: var(--brand-strong);
        font-weight: 600;
        cursor: pointer;
        transition: transform 150ms ease, box-shadow 150ms ease;
      }

      .theme-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 18px rgba(91, 33, 182, 0.12);
      }

      main {
        display: flex;
        flex-direction: column;
        gap: 32px;
      }

      .control-panel {
        position: sticky;
        top: 0;
        z-index: 4;
        background: linear-gradient(var(--bg-panel), var(--bg-panel));
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-soft);
        border: 1px solid var(--border-soft);
        padding: 28px 32px;
        display: flex;
        flex-direction: column;
        gap: 24px;
        backdrop-filter: blur(22px);
      }

      @media (max-width: 720px) {
        .control-panel {
          position: static;
        }
      }

      .control-panel header {
        display: flex;
        flex-wrap: wrap;
        gap: 16px 24px;
        align-items: center;
        justify-content: space-between;
      }

      .control-panel h2 {
        margin: 0;
        font-size: 1.1rem;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        color: var(--ink-subtle);
      }

      .control-grid {
        display: grid;
        gap: 24px;
        grid-template-columns: repeat(2, minmax(260px, 1fr));
        align-items: start;
      }

      @media (max-width: 1024px) {
        .control-grid {
          grid-template-columns: 1fr;
        }
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .control-group h3 {
        margin: 0;
        font-size: 0.95rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--ink-subtle);
      }

      .control-panel p {
        margin: 0;
        color: var(--ink-soft);
        line-height: 1.5;
      }

      .scenario-switch {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .scenario-button {
        border: 1px solid var(--border-soft);
        border-radius: var(--radius-md);
        padding: 16px 20px;
        text-align: left;
        background: rgba(255, 255, 255, 0.7);
        color: var(--ink-soft);
        display: flex;
        flex-direction: column;
        gap: 4px;
        cursor: pointer;
        min-width: clamp(220px, 24vw, 260px);
        transition: border-color 150ms ease, background 150ms ease, transform 150ms ease, box-shadow 150ms ease;
      }

      .scenario-button strong {
        font-size: 1.05rem;
        color: var(--ink-strong);
        letter-spacing: -0.01em;
      }

      .scenario-button span {
        font-size: 0.9rem;
        line-height: 1.45;
      }

      .scenario-button.active {
        border-color: var(--brand-soft);
        background: linear-gradient(135deg, rgba(91, 33, 182, 0.12), rgba(79, 70, 229, 0.05));
        transform: translateY(-2px);
        box-shadow: 0 12px 26px rgba(91, 33, 182, 0.16);
      }

      .slider-group {
        display: flex;
        flex-direction: column;
        gap: 14px;
        padding: 18px 20px 22px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-soft);
        background: rgba(255, 255, 255, 0.7);
      }

      .slider-group p {
        margin: 0;
        font-size: 0.85rem;
        color: var(--ink-subtle);
      }

      .slider-group header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .slider-group label {
        font-weight: 600;
        color: var(--ink-soft);
      }

      .slider-value {
        font-variant-numeric: tabular-nums;
        font-weight: 600;
        color: var(--brand-strong);
      }

      .slider-scale {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--ink-subtle);
      }

      input[type='range'] {
        appearance: none;
        width: 100%;
        height: 6px;
        border-radius: 999px;
        background: linear-gradient(90deg, var(--brand-soft), rgba(91, 33, 182, 0.2));
        outline: none;
      }

      input[type='range']::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--bg-panel);
        border: 2px solid var(--brand-strong);
        box-shadow: 0 4px 10px rgba(76, 29, 149, 0.2);
        transition: transform 150ms ease;
      }

      input[type='range']::-webkit-slider-thumb:hover {
        transform: scale(1.08);
      }

      input[type='range']::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--bg-panel);
        border: 2px solid var(--brand-strong);
        box-shadow: 0 4px 10px rgba(76, 29, 149, 0.2);
      }

      .lever-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .lever-grid label {
        display: inline-flex;
        gap: 12px;
        align-items: center;
        padding: 12px 16px;
        border-radius: 999px;
        border: 1px solid var(--border-soft);
        background: rgba(91, 33, 182, 0.08);
        font-size: 0.95rem;
        color: var(--brand-strong);
        transition: border-color 150ms ease, background 150ms ease;
      }

      .lever-grid input[type='checkbox'] {
        accent-color: var(--brand);
        width: 18px;
        height: 18px;
      }

      .lever-grid label:hover {
        border-color: var(--brand-soft);
        background: rgba(91, 33, 182, 0.12);
      }

      .content-column {
        display: grid;
        gap: 28px;
      }

      .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 20px;
      }

      .metric-card {
        background: var(--bg-panel);
        border-radius: var(--radius-md);
        padding: 20px 22px;
        border: 1px solid var(--border-soft);
        box-shadow: var(--shadow-soft);
      }

      .metric-card h3 {
        margin: 0;
        font-size: 0.8rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--ink-subtle);
      }

      .metric-card p {
        margin: 12px 0 0;
        font-size: 1.8rem;
        font-weight: 700;
        letter-spacing: -0.01em;
      }

      .metric-card span {
        display: block;
        margin-top: 6px;
        font-size: 0.88rem;
        color: var(--ink-subtle);
      }

      .chart-card {
        background: var(--bg-panel);
        border-radius: var(--radius-lg);
        padding: 24px 28px;
        border: 1px solid var(--border-soft);
        box-shadow: var(--shadow-soft);
        display: grid;
        gap: 12px;
      }

      .chart-card h3 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
      }

      svg {
        width: 100%;
        height: auto;
      }

      .summary-card {
        background: var(--bg-emphasis);
        border-radius: var(--radius-lg);
        padding: 28px;
        display: grid;
        gap: 16px;
        line-height: 1.6;
      }

      .summary-card h3 {
        margin: 0;
        font-size: 1.35rem;
      }

      .summary-card strong {
        color: var(--brand-strong);
      }

      .log-card {
        background: var(--bg-panel);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-soft);
        padding: 24px 28px;
        display: grid;
        gap: 14px;
      }

      .log-card ul {
        margin: 0;
        padding-left: 20px;
        color: var(--ink-soft);
        line-height: 1.55;
      }

      footer {
        padding: 0 32px 48px;
        color: var(--ink-subtle);
        text-align: center;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;

      const YEARS = [2021, 2022, 2023, 2024];
      const SCENARIO_DESCRIPTIONS = {
        wage: 'Weighted lottery leans on DOL Wage Levels to reward higher posted salaries.',
        statusquo: 'Random lottery mirrors the current two-stage draw without prioritization.',
        comp: 'Actual compensation ranking elevates the true salary offers regardless of Wage Levels.',
        hybrid: 'Blend Wage Level weighting with actual compensation to tune the emphasis.'
      };

      const SCENARIOS = {
        statusquo: {
          id: 'statusquo',
          label: 'Status quo lottery',
          median: [88, 91, 93, 95],
          p10: [55, 58, 60, 62],
          outsourcerShare: [0.21, 0.2, 0.19, 0.19],
          f1Share: [0.18, 0.19, 0.19, 0.2],
          phdShare: [0.09, 0.095, 0.1, 0.105],
          caption: "Today's random selection without prioritization."
        },
        wage: {
          id: 'wage',
          label: 'Weighted lottery (Wage Levels)',
          median: [90, 93, 95, 98],
          p10: [57, 60, 63, 70],
          outsourcerShare: [0.227, 0.216, 0.205, 0.205],
          f1Share: [0.167, 0.177, 0.177, 0.186],
          phdShare: [0.11, 0.116, 0.122, 0.128],
          caption: 'Boosts high Wage Level petitions while keeping the lottery structure.'
        },
        comp: {
          id: 'comp',
          label: 'Compensation ranking (actual pay)',
          median: [130, 138, 145, 159],
          p10: [95, 110, 120, 130],
          outsourcerShare: [0.084, 0.081, 0.077, 0.075],
          f1Share: [0.205, 0.215, 0.223, 0.236],
          phdShare: [0.165, 0.174, 0.182, 0.194],
          caption: 'Puts the highest salary offers first regardless of Wage Levels.'
        }
      };

      const BASELINE = SCENARIOS.statusquo;

      function blendArrays(a, b, weight) {
        return a.map((value, index) => value + (b[index] - value) * weight);
      }

      function applyLevers(metrics, levers) {
        const adjusted = JSON.parse(JSON.stringify(metrics));

        if (levers.outsourcer) {
          adjusted.outsourcerShare = adjusted.outsourcerShare.map((value) => value * 0.8);
          adjusted.median = adjusted.median.map((value) => value + 2);
        }

        if (levers.stem) {
          adjusted.f1Share = adjusted.f1Share.map((value) => Math.min(0.35, value + 0.015));
          adjusted.median = adjusted.median.map((value) => value + 1.5);
          adjusted.p10 = adjusted.p10.map((value) => value + 2);
        }

        if (levers.phd) {
          adjusted.phdShare = adjusted.phdShare.map((value) => Math.min(0.4, value * 1.25));
          adjusted.median = adjusted.median.map((value) => value + 3);
        }

        return adjusted;
      }

      function computeIndex(metrics) {
        const salaryFactor = metrics.median[3] / BASELINE.median[3];
        const phdFactor = metrics.phdShare[3] / BASELINE.phdShare[3];
        const outsourcerFactor = BASELINE.outsourcerShare[3] / metrics.outsourcerShare[3];
        return Math.round(100 * (0.6 * salaryFactor + 0.25 * phdFactor + 0.15 * outsourcerFactor));
      }

      function computeGrowth(metrics) {
        const wageLift = metrics.median.reduce((acc, value, index) => acc + (value - BASELINE.median[index]), 0);
        const phdLift = metrics.phdShare.reduce((acc, value, index) => acc + (value - BASELINE.phdShare[index]), 0);
        const outsourcerReduction = BASELINE.outsourcerShare.reduce(
          (acc, value, index) => acc + (value - metrics.outsourcerShare[index]),
          0
        );
        return wageLift * 0.4 + phdLift * 250 + outsourcerReduction * 120;
      }

      function readTokens() {
        const styles = getComputedStyle(document.body);
        const read = (name, fallback) => {
          const raw = styles.getPropertyValue(name);
          return (raw && raw.trim()) || fallback;
        };
        return {
          baseline: read('--chart-baseline', '#4338ca'),
          highlight: read('--chart-highlight', '#f59e0b'),
          accent: read('--chart-accent', '#5b21b6'),
          muted: read('--chart-muted', 'rgba(79, 70, 229, 0.28)'),
          grid: read('--chart-grid', 'rgba(79, 70, 229, 0.18)'),
          axis: read('--chart-axis', 'rgba(30, 41, 59, 0.72)'),
          font: "'Inter', system-ui, sans-serif"
        };
      }

      function createLinePath(points) {
        return points.map((point, index) => `${index === 0 ? 'M' : 'L'}${point[0]} ${point[1]}`).join(' ');
      }

      function drawWageChart(svg, metrics, tokens) {
        if (!svg) return;
        const viewBox = svg.getAttribute('viewBox').split(' ').map(Number);
        const [width, height] = [viewBox[2], viewBox[3]];
        const margin = { top: 32, right: 36, bottom: 52, left: 72 };
        const plotWidth = width - margin.left - margin.right;
        const plotHeight = height - margin.top - margin.bottom;

        const values = [...BASELINE.median, ...metrics.median, ...metrics.p10];
        const yMin = Math.min(...values) * 0.92;
        const yMax = Math.max(...values) * 1.05;
        const scaleX = (index) => margin.left + (plotWidth / (YEARS.length - 1)) * index;
        const scaleY = (value) => margin.top + plotHeight - ((value - yMin) / (yMax - yMin)) * plotHeight;

        svg.innerHTML = '';

        const axisGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        axisGroup.setAttribute('stroke', tokens.grid);
        axisGroup.setAttribute('stroke-width', '1');
        axisGroup.innerHTML = `
          <line x1="${margin.left}" y1="${margin.top + plotHeight}" x2="${margin.left + plotWidth}" y2="${margin.top + plotHeight}" />
          <line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${margin.top + plotHeight}" />
        `;
        svg.appendChild(axisGroup);

        const ticks = 5;
        for (let i = 0; i <= ticks; i += 1) {
          const value = yMin + ((yMax - yMin) / ticks) * i;
          const y = scaleY(value);

          const grid = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          grid.setAttribute('x1', margin.left);
          grid.setAttribute('x2', margin.left + plotWidth);
          grid.setAttribute('y1', y);
          grid.setAttribute('y2', y);
          grid.setAttribute('stroke', tokens.grid);
          grid.setAttribute('stroke-dasharray', '4 6');
          svg.appendChild(grid);

          const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          tick.setAttribute('x1', margin.left - 6);
          tick.setAttribute('x2', margin.left);
          tick.setAttribute('y1', y);
          tick.setAttribute('y2', y);
          tick.setAttribute('stroke', tokens.axis);
          svg.appendChild(tick);

          const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          label.setAttribute('x', margin.left - 12);
          label.setAttribute('y', y + 4);
          label.setAttribute('text-anchor', 'end');
          label.setAttribute('font-size', '12');
          label.setAttribute('fill', tokens.axis);
          label.setAttribute('font-family', tokens.font);
          label.textContent = `$${Math.round(value)}k`;
          svg.appendChild(label);
        }

        YEARS.forEach((year, index) => {
          const x = scaleX(index);
          const tick = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          tick.setAttribute('x', x);
          tick.setAttribute('y', margin.top + plotHeight + 30);
          tick.setAttribute('text-anchor', 'middle');
          tick.setAttribute('font-size', '12');
          tick.setAttribute('fill', tokens.axis);
          tick.setAttribute('font-family', tokens.font);
          tick.textContent = year;
          svg.appendChild(tick);
        });

        const basePoints = BASELINE.median.map((value, index) => [scaleX(index), scaleY(value)]);
        const scenarioMedianPoints = metrics.median.map((value, index) => [scaleX(index), scaleY(value)]);
        const scenarioP10Points = metrics.p10.map((value, index) => [scaleX(index), scaleY(value)]);

        const basePath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        basePath.setAttribute('d', createLinePath(basePoints));
        basePath.setAttribute('fill', 'none');
        basePath.setAttribute('stroke', tokens.muted);
        basePath.setAttribute('stroke-width', '3');
        svg.appendChild(basePath);

        const medianPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        medianPath.setAttribute('d', createLinePath(scenarioMedianPoints));
        medianPath.setAttribute('fill', 'none');
        medianPath.setAttribute('stroke', tokens.accent);
        medianPath.setAttribute('stroke-width', '4');
        svg.appendChild(medianPath);

        const p10Path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        p10Path.setAttribute('d', createLinePath(scenarioP10Points));
        p10Path.setAttribute('fill', 'none');
        p10Path.setAttribute('stroke', tokens.highlight);
        p10Path.setAttribute('stroke-width', '3');
        p10Path.setAttribute('stroke-dasharray', '8 6');
        svg.appendChild(p10Path);
      }

      function drawShareChart(svg, metrics, tokens) {
        if (!svg) return;
        const viewBox = svg.getAttribute('viewBox').split(' ').map(Number);
        const [width, height] = [viewBox[2], viewBox[3]];
        const margin = { top: 28, right: 40, bottom: 32, left: 160 };
        const plotWidth = width - margin.left - margin.right;
        const rowHeight = (height - margin.top - margin.bottom) / 3;

        svg.innerHTML = '';

        const groups = [
          { label: 'Large outsourcers', base: BASELINE.outsourcerShare[3], scenario: metrics.outsourcerShare[3] },
          { label: 'F-1 graduates', base: BASELINE.f1Share[3], scenario: metrics.f1Share[3] },
          { label: 'PhD holders', base: BASELINE.phdShare[3], scenario: metrics.phdShare[3] }
        ];

        const xMax = Math.max(...groups.map((group) => Math.max(group.base, group.scenario))) * 1.2;

        groups.forEach((group, index) => {
          const y = margin.top + index * rowHeight;
          const baseWidth = (group.base / xMax) * plotWidth;
          const scenarioWidth = (group.scenario / xMax) * plotWidth;

          const baseRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          baseRect.setAttribute('x', margin.left);
          baseRect.setAttribute('y', y + 12);
          baseRect.setAttribute('width', baseWidth);
          baseRect.setAttribute('height', rowHeight - 24);
          baseRect.setAttribute('fill', tokens.muted);
          baseRect.setAttribute('rx', 10);
          svg.appendChild(baseRect);

          const scenarioRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          scenarioRect.setAttribute('x', margin.left);
          scenarioRect.setAttribute('y', y + 12);
          scenarioRect.setAttribute('width', scenarioWidth);
          scenarioRect.setAttribute('height', rowHeight - 24);
          scenarioRect.setAttribute('fill', tokens.accent);
          scenarioRect.setAttribute('rx', 10);
          scenarioRect.setAttribute('opacity', '0.9');
          svg.appendChild(scenarioRect);

          const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          label.setAttribute('x', margin.left - 12);
          label.setAttribute('y', y + rowHeight / 2 + 4);
          label.setAttribute('text-anchor', 'end');
          label.setAttribute('font-size', '14');
          label.setAttribute('fill', tokens.axis);
          label.setAttribute('font-family', tokens.font);
          label.textContent = group.label;
          svg.appendChild(label);

          const baseLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          baseLabel.setAttribute('x', margin.left + baseWidth + 12);
          baseLabel.setAttribute('y', y + rowHeight / 2 - 2);
          baseLabel.setAttribute('font-size', '12');
          baseLabel.setAttribute('fill', tokens.axis);
          baseLabel.setAttribute('font-family', tokens.font);
          baseLabel.textContent = `${(group.base * 100).toFixed(1)}% baseline`;
          svg.appendChild(baseLabel);

          const scenarioLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          scenarioLabel.setAttribute('x', margin.left + scenarioWidth + 12);
          scenarioLabel.setAttribute('y', y + rowHeight / 2 + 14);
          scenarioLabel.setAttribute('font-size', '12');
          scenarioLabel.setAttribute('fill', tokens.accent);
          scenarioLabel.setAttribute('font-family', tokens.font);
          scenarioLabel.textContent = `${(group.scenario * 100).toFixed(1)}% scenario`;
          svg.appendChild(scenarioLabel);
        });
      }

      function drawProductivityChart(svg, metrics, indexScore, tokens) {
        if (!svg) return;
        const viewBox = svg.getAttribute('viewBox').split(' ').map(Number);
        const [width, height] = [viewBox[2], viewBox[3]];
        const margin = { top: 36, right: 32, bottom: 48, left: 70 };
        const plotWidth = width - margin.left - margin.right;
        const plotHeight = height - margin.top - margin.bottom;

        const xValues = [BASELINE.median[3], metrics.median[3]];
        const yValues = [100, indexScore];
        const xMin = Math.min(...xValues) * 0.95;
        const xMax = Math.max(...xValues) * 1.05;
        const yMin = Math.min(...yValues) * 0.94;
        const yMax = Math.max(...yValues) * 1.06;

        const scaleX = (value) => margin.left + ((value - xMin) / (xMax - xMin)) * plotWidth;
        const scaleY = (value) => margin.top + plotHeight - ((value - yMin) / (yMax - yMin)) * plotHeight;

        svg.innerHTML = '';

        const axisX = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        axisX.setAttribute('x1', margin.left);
        axisX.setAttribute('x2', margin.left + plotWidth);
        axisX.setAttribute('y1', margin.top + plotHeight);
        axisX.setAttribute('y2', margin.top + plotHeight);
        axisX.setAttribute('stroke', tokens.grid);
        svg.appendChild(axisX);

        const axisY = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        axisY.setAttribute('x1', margin.left);
        axisY.setAttribute('x2', margin.left);
        axisY.setAttribute('y1', margin.top);
        axisY.setAttribute('y2', margin.top + plotHeight);
        axisY.setAttribute('stroke', tokens.grid);
        svg.appendChild(axisY);

        [BASELINE.median[3], metrics.median[3]].forEach((value) => {
          const x = scaleX(value);
          const grid = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          grid.setAttribute('x1', x);
          grid.setAttribute('x2', x);
          grid.setAttribute('y1', margin.top);
          grid.setAttribute('y2', margin.top + plotHeight);
          grid.setAttribute('stroke', tokens.grid);
          grid.setAttribute('stroke-dasharray', '6 6');
          svg.appendChild(grid);
        });

        [100, indexScore].forEach((value) => {
          const y = scaleY(value);
          const grid = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          grid.setAttribute('x1', margin.left);
          grid.setAttribute('x2', margin.left + plotWidth);
          grid.setAttribute('y1', y);
          grid.setAttribute('y2', y);
          grid.setAttribute('stroke', tokens.grid);
          grid.setAttribute('stroke-dasharray', '6 6');
          svg.appendChild(grid);
        });

        const baselineCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        baselineCircle.setAttribute('cx', scaleX(BASELINE.median[3]));
        baselineCircle.setAttribute('cy', scaleY(100));
        baselineCircle.setAttribute('r', 12);
        baselineCircle.setAttribute('fill', tokens.muted);
        svg.appendChild(baselineCircle);

        const scenarioCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        scenarioCircle.setAttribute('cx', scaleX(metrics.median[3]));
        scenarioCircle.setAttribute('cy', scaleY(indexScore));
        scenarioCircle.setAttribute('r', 14);
        scenarioCircle.setAttribute('fill', tokens.accent);
        scenarioCircle.setAttribute('fill-opacity', '0.9');
        scenarioCircle.setAttribute('stroke', '#ffffff');
        scenarioCircle.setAttribute('stroke-width', '2');
        svg.appendChild(scenarioCircle);

        const baseLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        baseLabel.setAttribute('x', scaleX(BASELINE.median[3]));
        baseLabel.setAttribute('y', scaleY(100) + 28);
        baseLabel.setAttribute('text-anchor', 'middle');
        baseLabel.setAttribute('font-size', '12');
        baseLabel.setAttribute('fill', tokens.axis);
        baseLabel.setAttribute('font-family', tokens.font);
        baseLabel.textContent = `Baseline ¬∑ $${BASELINE.median[3]}k ¬∑ 100 index`;
        svg.appendChild(baseLabel);

        const scenarioLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        scenarioLabel.setAttribute('x', scaleX(metrics.median[3]));
        scenarioLabel.setAttribute('y', scaleY(indexScore) - 20);
        scenarioLabel.setAttribute('text-anchor', 'middle');
        scenarioLabel.setAttribute('font-size', '13');
        scenarioLabel.setAttribute('fill', tokens.accent);
        scenarioLabel.setAttribute('font-family', tokens.font);
        scenarioLabel.textContent = `${metrics.label || 'Scenario'} ¬∑ $${Math.round(metrics.median[3])}k ¬∑ ${indexScore}`;
        svg.appendChild(scenarioLabel);
      }

      function MetricCard({ title, value, detail }) {
        return (
          <article className="metric-card">
            <h3>{title}</h3>
            <p>{value}</p>
            <span>{detail}</span>
          </article>
        );
      }

      function ScenarioButton({ id, label, caption, active, onClick }) {
        return (
          <button
            type="button"
            className={`scenario-button${active ? ' active' : ''}`}
            aria-pressed={active}
            onClick={() => onClick(id)}
          >
            <strong>{label}</strong>
            <span>{caption}</span>
          </button>
        );
      }

      function useStoredTheme() {
        const read = () => {
          try {
            return window.localStorage.getItem('ifp-theme') === 'sepia';
          } catch (error) {
            return false;
          }
        };

        const [isSepia, setIsSepia] = useState(read);

        useEffect(() => {
          document.body.classList.toggle('theme-sepia', isSepia);
          try {
            window.localStorage.setItem('ifp-theme', isSepia ? 'sepia' : 'modern');
          } catch (error) {
            /* ignore */
          }
        }, [isSepia]);

        return [isSepia, setIsSepia];
      }

      function App() {
        const [policy, setPolicy] = useState('wage');
        const [compWeight, setCompWeight] = useState(60);
        const [levers, setLevers] = useState({ outsourcer: true, stem: true, phd: false });
        const [isSepia, setIsSepia] = useStoredTheme();

        const tokens = useMemo(readTokens, [isSepia]);

        const metrics = useMemo(() => {
          if (policy === 'hybrid') {
            const weight = compWeight / 100;
            const hybridMetrics = {
              label: `Hybrid weighting (${compWeight}% compensation)`,
              median: blendArrays(SCENARIOS.wage.median, SCENARIOS.comp.median, weight),
              p10: blendArrays(SCENARIOS.wage.p10, SCENARIOS.comp.p10, weight),
              outsourcerShare: blendArrays(
                SCENARIOS.wage.outsourcerShare,
                SCENARIOS.comp.outsourcerShare,
                weight
              ),
              f1Share: blendArrays(SCENARIOS.wage.f1Share, SCENARIOS.comp.f1Share, weight),
              phdShare: blendArrays(SCENARIOS.wage.phdShare, SCENARIOS.comp.phdShare, weight)
            };
            return applyLevers(hybridMetrics, levers);
          }

          const base = applyLevers(SCENARIOS[policy], levers);
          return { ...base, label: SCENARIOS[policy].label };
        }, [policy, compWeight, levers]);

        const indexScore = useMemo(() => computeIndex(metrics), [metrics]);
        const growthScore = useMemo(() => computeGrowth(metrics), [metrics]);

        const summary = useMemo(() => {
          const outsourcerPct = (metrics.outsourcerShare[3] * 100).toFixed(1);
          const outsourcerDelta = ((metrics.outsourcerShare[3] / BASELINE.outsourcerShare[3] - 1) * 100).toFixed(1);
          const f1Pct = (metrics.f1Share[3] * 100).toFixed(1);
          const phdPct = (metrics.phdShare[3] * 100).toFixed(1);
          const wageDelta = Math.round(metrics.median[3] - BASELINE.median[3]);
          const floorDelta = Math.round(metrics.p10[3] - BASELINE.p10[3]);
          const growthText =
            growthScore >= 0
              ? `adds ${(growthScore / 10).toFixed(1)} points to a national productivity composite`
              : `subtracts ${(Math.abs(growthScore) / 10).toFixed(1)} points from a national productivity composite`;

          return (
            <>
              <h3>{metrics.label || 'Scenario summary'}</h3>
              <p>
                Compared with today&apos;s random lottery, this rule lifts the innovation index to <strong>{indexScore}</strong>.
                Median salaries reach <strong>${Math.round(metrics.median[3])}k</strong>,
                {' '}
                {wageDelta >= 0 ? 'up' : 'down'} {Math.abs(wageDelta)}k from the status quo, while the wage floor at the 10th
                percentile sits at <strong>${Math.round(metrics.p10[3])}k</strong>{' '}
                ({floorDelta >= 0 ? '+' : '-'}{Math.abs(floorDelta)}k).
              </p>
              <p>
                Outsourcers now hold <strong>{outsourcerPct}%</strong> of visas ({outsourcerDelta >= 0 ? '+' : ''}
                {outsourcerDelta}% shift), US-educated F-1 graduates capture <strong>{f1Pct}%</strong>, and PhD holders
                represent <strong>{phdPct}%</strong> of awards. Overall this mix {growthText}.
              </p>
            </>
          );
        }, [metrics, indexScore, growthScore]);

        const leverLog = useMemo(() => {
          const entries = [];
          entries.push(SCENARIO_DESCRIPTIONS[policy]);
          if (policy === 'hybrid') {
            entries.push(`Hybrid slider fixed at ${compWeight}% emphasis on actual compensation.`);
          }
          if (levers.outsourcer) {
            entries.push('Outsourcer guardrails trim large outsourcer wins by roughly 20% before redistribution.');
          }
          if (levers.stem) {
            entries.push('STEM boost reserves room for US-trained graduates, lifting F-1 share by about 1.5 points.');
          }
          if (levers.phd) {
            entries.push('PhD credit rewards research-heavy teams with a 25% lift in doctoral selections.');
          }
          if (!levers.outsourcer && !levers.stem && !levers.phd) {
            entries.push('No supplemental levers engaged‚Äîresults flow entirely from your base template.');
          }
          if (isSepia) {
            entries.push('Heritage mode active: sepia palette and archival typography.');
          }
          return entries;
        }, [policy, compWeight, levers, isSepia]);

        const sliderNarrative = useMemo(() => {
          if (compWeight <= 30) {
            return 'Prioritizes wage-ranking signals, keeping the lottery closer to today\'s prevailing wage tables.';
          }
          if (compWeight >= 70) {
            return 'Leans into real compensation data so premium offers surge to the front of the line.';
          }
          return 'Balances wage tables with actual compensation to smooth volatility between sectors.';
        }, [compWeight]);

        const wageChartRef = useRef(null);
        const shareChartRef = useRef(null);
        const productivityChartRef = useRef(null);

        useEffect(() => {
          drawWageChart(wageChartRef.current, metrics, tokens);
          drawShareChart(shareChartRef.current, metrics, tokens);
          drawProductivityChart(productivityChartRef.current, metrics, indexScore, tokens);
        }, [metrics, tokens, indexScore]);

        const metricCards = [
          {
            title: 'Median salary',
            value: `$${Math.round(metrics.median[3])}k`,
            detail: 'Petition median in 2024'
          },
          {
            title: 'Opportunity floor',
            value: `$${Math.round(metrics.p10[3])}k`,
            detail: '10th percentile salary in 2024'
          },
          {
            title: 'Outsourcer share',
            value: `${(metrics.outsourcerShare[3] * 100).toFixed(1)}%`,
            detail: 'Share of visas to large outsourcers'
          },
          {
            title: 'Innovation index',
            value: `${indexScore}`,
            detail: 'Composite of wages, PhDs, and outsourcer shifts'
          },
          {
            title: 'F-1 talent pipeline',
            value: `${(metrics.f1Share[3] * 100).toFixed(1)}%`,
            detail: 'Share of visas to US-educated graduates'
          },
          {
            title: 'PhD share',
            value: `${(metrics.phdShare[3] * 100).toFixed(1)}%`,
            detail: 'Share of visas to PhD holders'
          }
        ];

        const leverOptions = [
          { id: 'outsourcer', label: 'Impose outsourcer fee & L-1 guardrails' },
          { id: 'stem', label: 'Priority for US STEM graduates' },
          { id: 'phd', label: 'R&D credit for PhD-intensive employers' }
        ];

        const scenarioOptions = [
          { id: 'wage', label: SCENARIOS.wage.label, caption: SCENARIOS.wage.caption },
          { id: 'statusquo', label: SCENARIOS.statusquo.label, caption: SCENARIOS.statusquo.caption },
          { id: 'comp', label: SCENARIOS.comp.label, caption: SCENARIOS.comp.caption },
          { id: 'hybrid', label: 'Hybrid weighting', caption: 'Blend Wage Levels with true pay using the slider.' }
        ];

        return (
          <>
            <div className="page">
            <header>
              <div className="brand">
                <img src="assets/ifp-logo.svg" alt="IFP logo" />
                <div>
                  <h1>H-1B Policy Lab</h1>
                  <p>
                    Explore how different immigration rules shift the talent mix, wage floor, and innovation index for the H-1B
                    program. Toggle the levers to see who benefits and how outcomes evolve.
                  </p>
                </div>
              </div>
              <button className="theme-toggle" type="button" onClick={() => setIsSepia((value) => !value)}>
                <span aria-hidden="true">üéûÔ∏è</span>
                <span>{isSepia ? 'Return to modern mode' : 'Enter heritage mode'}</span>
              </button>
            </header>

            <main>
              <section className="control-panel" aria-label="Scenario controls">
                <header>
                  <h2>Adjust the rule set</h2>
                  <p>{SCENARIO_DESCRIPTIONS[policy]}</p>
                </header>

                <div className="control-grid">
                  <div className="control-group">
                    <h3>Choose a template</h3>
                    <section className="scenario-switch" role="radiogroup" aria-label="Select a policy template">
                      {scenarioOptions.map((option) => (
                        <ScenarioButton
                          key={option.id}
                          id={option.id}
                          label={option.label}
                          caption={option.caption}
                          active={policy === option.id}
                          onClick={(value) => setPolicy(value)}
                        />
                      ))}
                    </section>
                  </div>

                  <div className="control-group">
                    <h3>Fine-tune levers</h3>
                    {policy === 'hybrid' && (
                      <div className="slider-group" role="group" aria-labelledby="comp-weight-label">
                        <header>
                          <label id="comp-weight-label" htmlFor="comp-weight">
                            Hybrid emphasis on actual compensation
                          </label>
                          <span className="slider-value" aria-live="polite">
                            {compWeight}%
                          </span>
                        </header>
                        <input
                          id="comp-weight"
                          type="range"
                          min="0"
                          max="100"
                          step="5"
                          value={compWeight}
                          aria-valuemin={0}
                          aria-valuemax={100}
                          aria-valuenow={compWeight}
                          aria-valuetext={`${compWeight}% emphasis on compensation`}
                          aria-describedby="comp-weight-helper"
                          onChange={(event) => setCompWeight(Number(event.target.value))}
                        />
                        <div className="slider-scale" aria-hidden="true">
                          <span>0%</span>
                          <span>50%</span>
                          <span>100%</span>
                        </div>
                        <p id="comp-weight-helper">{sliderNarrative}</p>
                      </div>
                    )}

                    <div className="lever-grid" role="group" aria-label="Activate policy levers">
                      {leverOptions.map((lever) => (
                        <label key={lever.id} htmlFor={`lever-${lever.id}`}>
                          <input
                            id={`lever-${lever.id}`}
                            type="checkbox"
                            checked={levers[lever.id]}
                            onChange={(event) =>
                              setLevers((current) => ({ ...current, [lever.id]: event.target.checked }))
                            }
                          />
                          {lever.label}
                        </label>
                      ))}
                    </div>
                  </div>
                </div>
              </section>

              <div className="content-column">
                <section className="metric-grid" aria-label="Key outcome metrics">
                  {metricCards.map((card) => (
                    <MetricCard key={card.title} {...card} />
                  ))}
                </section>

                <section className="chart-card">
                  <h3>Wage outcomes across time</h3>
                  <svg ref={wageChartRef} viewBox="0 0 720 360" role="img" aria-labelledby="wage-chart-title wage-chart-desc">
                    <title id="wage-chart-title">Median and 10th percentile salaries, 2021‚Äì2024</title>
                    <desc id="wage-chart-desc">Line chart comparing the baseline lottery against the selected policy.</desc>
                  </svg>
                </section>

                <section className="chart-card">
                  <h3>Who receives visas in 2024</h3>
                  <svg ref={shareChartRef} viewBox="0 0 720 280" role="img" aria-labelledby="share-chart-title share-chart-desc">
                    <title id="share-chart-title">Share of visas for outsourcers, F-1 graduates, and PhDs</title>
                    <desc id="share-chart-desc">Horizontal bars comparing the baseline lottery against the selected policy.</desc>
                  </svg>
                </section>

                <section className="chart-card">
                  <h3>Innovation &amp; productivity index</h3>
                  <svg
                    ref={productivityChartRef}
                    viewBox="0 0 720 320"
                    role="img"
                    aria-labelledby="productivity-chart-title productivity-chart-desc"
                  >
                    <title id="productivity-chart-title">Innovation index versus median wage</title>
                    <desc id="productivity-chart-desc">Scatter plot comparing baseline and selected policy outcomes.</desc>
                  </svg>
                </section>

                <section className="summary-card" aria-live="polite">
                  {summary}
                </section>

                <section className="log-card" aria-live="polite">
                  <h3 style={{ margin: 0 }}>Lever log</h3>
                  <ul>
                    {leverLog.map((item, index) => (
                      <li key={index}>{item}</li>
                    ))}
                  </ul>
                </section>
              </div>
            </main>
          </div>
          <footer>
            Updated in React for a cleaner, more legible exploration of H-1B policy scenarios.
          </footer>
          </>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
